name: Orchid Dynamic Rate Limit from Headers
description: |
  Test Orchid's ability to read rate limit information from response headers
  and adjust its behavior accordingly. Uses X-RateLimit-* headers.

steps:
  # ============================================================================
  # SETUP: Generate unique mock path
  # ============================================================================
  - set_variable:
      name: mock_path
      value: "/mock/dynamic-rate-{{uuid}}"

  - http_request:
      service: mocks
      method: POST
      path: /api/test/configure
      body:
        method: GET
        path: "{{mock_path}}"
        response:
          status: 200
          headers:
            X-RateLimit-Limit: "100"
            X-RateLimit-Remaining: "95"
            X-RateLimit-Reset: "1704067200"
            X-RateLimit-Used: "5"
          body:
            data:
              id: "item-001"
              name: "Rate Limited Item"
              status: "active"
            rate_info:
              limit: 100
              remaining: 95
              reset_at: "2024-01-01T00:00:00Z"
      expect:
        status: 200

  # Create integration
  - http_request:
      service: orchid
      method: POST
      path: /api/v1/integrations
      body:
        name: "Dynamic Rate Limit Test {{uuid}}"
        description: "Test dynamic rate limiting from headers"
        config_schema:
          name: "Dynamic Rate Config"
          schema:
            type: object
            properties:
              base_url:
                type: string
            required:
              - base_url
      expect:
        status: 201
      save_as: integration

  - http_request:
      service: orchid
      method: POST
      path: /api/v1/configs
      body:
        integration_id: "{{integration.id}}"
        name: "Dynamic Rate Limit Config"
        values:
          base_url: "{{mocks_url}}"
        enabled: true
      expect:
        status: 201
      save_as: config

  # Create plan that reads rate limits from headers
  - http_request:
      service: orchid
      method: POST
      path: /api/v1/plans
      body:
        integration_id: "{{integration.id}}"
        key: "dynamic-rate-limit-{{uuid}}"
        name: "Dynamic Rate Limit Plan"
        description: "Plan that respects rate limits from headers"
        enabled: true
        plan_definition:
          step:
            url: "{{ config.base_url }}{{mock_path}}"
            method: GET
            rate_limit:
              dynamic: true
              header_limit: "X-RateLimit-Limit"
              header_remaining: "X-RateLimit-Remaining"
              header_reset: "X-RateLimit-Reset"
          max_execution_seconds: 30
      expect:
        status: 201
      save_as: plan

  # Record Kafka offset
  # Trigger execution
  - get_kafka_offset:
      topic: api-responses
      save_as: kafka_offset_before

  - http_request:
      service: orchid
      method: POST
      path: /api/v1/plans/{{plan.key}}/trigger
      body:
        config_id: "{{config.id}}"
      expect:
        status: 200
      save_as: trigger

  # Verify response includes rate limit headers
  - assert_kafka_message:
      topic: api-responses
      timeout: 30s
      from_offset: "{{kafka_offset_before}}"
      filter:
        headers:
          plan_key: "{{plan.key}}"
        has_field: request_url
        field_contains: request_url
        contains_value: "{{mock_path}}"
      assertions:
        - field: plan_key
          equals: "{{plan.key}}"
        - field: status_code
          equals: 200
        - field: response_headers.X-Ratelimit-Limit
          equals: "100"
        - field: response_headers.X-Ratelimit-Remaining
          equals: "95"
        - field: response_headers.X-Ratelimit-Used
          equals: "5"
        - field: response_body[0].data.id
          equals: "item-001"
        - field: response_body[0].data.name
          equals: "Rate Limited Item"
        - field: response_body[0].data.status
          equals: "active"
        - field: response_body[0].rate_info.limit
          equals: 100
        - field: response_body[0].rate_info.remaining
          equals: 95
      save_as: dynamic_rate_response

cleanup:
  - http_request:
      service: mocks
      method: POST
      path: /api/test/configure/delete
      body:
        method: GET
        path: "{{mock_path}}"

  - http_request:
      service: orchid
      method: DELETE
      path: /api/v1/plans/{{plan.key}}

  - http_request:
      service: orchid
      method: DELETE
      path: /api/v1/configs/{{config.id}}

  - http_request:
      service: orchid
      method: DELETE
      path: /api/v1/integrations/{{integration.id}}

