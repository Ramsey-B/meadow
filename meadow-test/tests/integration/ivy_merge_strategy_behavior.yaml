name: Ivy Merge Strategy Behavior Tests
description: |
  Tests that multiple entities with the same email are both processed:
  1. First entity creates merged entity with source_count=1
  2. Second entity with same email triggers another CDC event
  3. Verifies the CDC pipeline processes both entities

setup:
  # Create unique identifiers
  - set_variable:
      name: strategy_email
      value: "strategy.test.{{uuid}}@example.com"

  # Create entity type
  - http_request:
      service: ivy
      method: POST
      path: /api/v1/entity-types
      body:
        name: "Strategy Test Person"
        key: "strategyperson{{timestamp}}"
        description: "Person for merge strategy tests"
        schema:
          type: object
          properties:
            email:
              type: string
              format: email
            first_name:
              type: string
            last_name:
              type: string
            phone:
              type: string
            title:
              type: string
            department:
              type: string
          required:
            - email
      expect:
        status: 201
      save_as: strategy_type

  # Create match rule
  - http_request:
      service: ivy
      method: POST
      path: /api/v1/match-rules
      body:
        entity_type: "{{strategy_type.key}}"
        name: "Strategy Email Match"
        description: "Match by email for strategy tests"
        priority: 100
        is_active: true
        score_weight: 1.0
        conditions:
          - field: "email"
            match_type: "exact"
            weight: 1.0
            required: true
            case_sensitive: false
      expect:
        status: 201
      save_as: strategy_rule

  # Get Kafka offsets
  - get_kafka_offset:
      topic: ivy.public.merged_entities
      save_as: merged_offset

steps:
  # ============================================
  # Step 1: Send first entity (source 1)
  # ============================================
  
  - publish_kafka:
      topic: mapped-data
      key: "strategy-first-{{uuid}}"
      headers:
        tenant_id: "{{test_tenant}}"
        content_type: "application/json"
      value:
        source:
          type: "orchid"
          tenant_id: "{{test_tenant}}"
          integration: "okta"
          key: "users_sync"
          config_id: "okta-strategy-{{uuid}}"
          execution_id: "okta-strategy-exec-{{uuid}}"
        tenant_id: "{{test_tenant}}"
        execution_id: "okta-strategy-exec-{{uuid}}"
        source_key: "users_sync"
        config_id: "okta-strategy-{{uuid}}"
        integration: "okta"
        timestamp: "2026-01-11T09:00:00Z"
        target_schema:
          type: "entity"
          entity_type: "{{strategy_type.key}}"
        data:
          email: "{{strategy_email}}"
          first_name: "Alice"
          phone: "555-0001"
          source_id: "okta-strategy-{{uuid}}"

  - wait:
      duration: "10s"
      reason: "Wait for first entity to be fully processed and indexed"

  # Verify first entity created merged record with source_count=1
  - assert_kafka_message:
      topic: ivy.public.merged_entities
      from_offset: "{{merged_offset}}"
      timeout: 30s
      filter:
        skip_tenant_header_filter: true
        field_contains: payload.after.entity_type
        contains_value: "{{strategy_type.key}}"
      assertions:
        - field: payload.after.tenant_id
          equals: "{{test_tenant}}"
        - field: payload.op
          equals: "c"
        - field: payload.after.source_count
          equals: 1
      save_as: first_merged

  # ============================================
  # Step 2: Send second entity (source 2) - same email
  # ============================================
  
  - get_kafka_offset:
      topic: ivy.public.merged_entities
      save_as: merged_offset_2

  - publish_kafka:
      topic: mapped-data
      key: "strategy-second-{{uuid}}"
      headers:
        tenant_id: "{{test_tenant}}"
        content_type: "application/json"
      value:
        source:
          type: "orchid"
          tenant_id: "{{test_tenant}}"
          integration: "msgraph"
          key: "users_sync"
          config_id: "msgraph-strategy-{{uuid}}"
          execution_id: "msgraph-strategy-exec-{{uuid}}"
        tenant_id: "{{test_tenant}}"
        execution_id: "msgraph-strategy-exec-{{uuid}}"
        source_key: "users_sync"
        config_id: "msgraph-strategy-{{uuid}}"
        integration: "msgraph"
        timestamp: "2026-01-11T10:00:00Z"
        target_schema:
          type: "entity"
          entity_type: "{{strategy_type.key}}"
        data:
          email: "{{strategy_email}}"
          last_name: "Strategy"
          title: "Engineer"
          department: "Engineering"
          source_id: "msgraph-strategy-{{uuid}}"

  - wait:
      duration: "10s"
      reason: "Wait for merge processing to complete"

  # ============================================
  # Step 3: Verify second entity was processed
  # ============================================
  
  - assert_kafka_message:
      topic: ivy.public.merged_entities
      from_offset: "{{merged_offset_2}}"
      timeout: 30s
      filter:
        skip_tenant_header_filter: true
        field_contains: payload.after.entity_type
        contains_value: "{{strategy_type.key}}"
      assertions:
        - field: payload.after.tenant_id
          equals: "{{test_tenant}}"
        # Verify second entity triggered a CDC event
        - field: payload.op
          not_empty: true
      save_as: merged_result

  # Verify the entity type is correct
  - assert:
      variable: merged_result.payload.after.entity_type
      contains: "strategyperson"
      message: "Merged entity should have correct entity type"

cleanup:
  # Delete match rule
  - http_request:
      service: ivy
      method: DELETE
      path: /api/v1/match-rules/{{strategy_rule.id}}
      expect:
        status_one_of: [200, 204, 404]

  # Delete entity type
  - http_request:
      service: ivy
      method: DELETE
      path: /api/v1/entity-types/{{strategy_type.id}}
      expect:
        status_one_of: [200, 204, 404]
