name: Orchid Abort on 403 Forbidden
description: |
  Test that Orchid aborts execution when receiving 403 Forbidden.
  This tests scenarios where authentication succeeds but authorization fails.

steps:
  # ============================================================================
  # SETUP: Generate unique mock path
  # ============================================================================
  - set_variable:
      name: mock_path
      value: "/mock/forbidden-{{uuid}}"

  - http_request:
      service: mocks
      method: POST
      path: /api/test/configure
      body:
        method: GET
        path: "{{mock_path}}"
        response:
          status: 403
          body:
            error: "forbidden"
            message: "Access denied. Insufficient permissions to access this resource."
            code: "AUTH_INSUFFICIENT_PERMISSIONS"
            required_permissions:
              - "read:users"
              - "admin:system"
      expect:
        status: 200

  # Create integration
  - http_request:
      service: orchid
      method: POST
      path: /api/v1/integrations
      body:
        name: "Abort 403 Test {{uuid}}"
        description: "Test abort behavior on forbidden"
        config_schema:
          name: "Abort 403 Config"
          schema:
            type: object
            properties:
              base_url:
                type: string
            required:
              - base_url
      expect:
        status: 201
      save_as: integration

  - http_request:
      service: orchid
      method: POST
      path: /api/v1/configs
      body:
        integration_id: "{{integration.id}}"
        name: "Abort 403 Config"
        values:
          base_url: "{{mocks_url}}"
        enabled: true
      expect:
        status: 201
      save_as: config

  # Create plan that should abort on 403
  - http_request:
      service: orchid
      method: POST
      path: /api/v1/plans
      body:
        integration_id: "{{integration.id}}"
        key: "abort-403-{{uuid}}"
        name: "Abort on 403 Plan"
        description: "Plan that should abort on forbidden"
        enabled: true
        plan_definition:
          step:
            url: "{{ config.base_url }}{{mock_path}}"
            method: GET
            abort_on: [401, 403]
          max_execution_seconds: 30
      expect:
        status: 201
      save_as: plan

  # Trigger execution
  - get_kafka_offset:
      topic: api-responses
      save_as: kafka_offset_before

  - http_request:
      service: orchid
      method: POST
      path: /api/v1/plans/{{plan.key}}/trigger
      body:
        config_id: "{{config.id}}"
      expect:
        status: 200
      save_as: trigger

  # Wait for execution to abort using polling template
  - use_template:
      name: wait_for_execution_status
      with:
        plan_key: "{{plan.key}}"
        status: "aborted"
        timeout: "10s"

  - assert:
      variable: executions
      not_empty: true
      message: Should have execution record

  # Verify execution was aborted
  - assert:
      variable: executions[0].status
      equals: "aborted"
      message: Execution should be aborted on 403

  - assert:
      variable: executions[0].error_message
      contains: "abort"
      message: Error message should indicate abort

cleanup:
  - http_request:
      service: mocks
      method: POST
      path: /api/test/configure/delete
      body:
        method: GET
        path: "{{mock_path}}"

  - http_request:
      service: orchid
      method: DELETE
      path: /api/v1/plans/{{plan.key}}

  - http_request:
      service: orchid
      method: DELETE
      path: /api/v1/configs/{{config.id}}

  - http_request:
      service: orchid
      method: DELETE
      path: /api/v1/integrations/{{integration.id}}

