name: Lotus Mapping and Binding CRUD
description: Test creating, testing, and deleting Lotus mapping definitions and bindings

steps:
  # Create a simple mapping definition
  - http_request:
      service: lotus
      method: POST
      path: /api/v1/mappings/definitions
      body:
        name: "Test User Mapping {{uuid}}"
        key: "test-user-mapping-{{uuid}}"
        description: "Simple mapping for testing"
        source_fields:
          - id: src_id
            path: "data.id"
            type: string
          - id: src_name
            path: "data.name"
            type: string
          - id: src_email
            path: "data.email"
            type: string
        target_fields:
          - id: tgt_source_id
            path: "_source_id"
            type: string
          - id: tgt_entity_type
            path: "_entity_type"
            type: string
          - id: tgt_name
            path: "name"
            type: string
          - id: tgt_email
            path: "email"
            type: string
        steps:
          - id: lowercase_email
            type: transformer
            action:
              key: text_to_lower
        links:
          - source:
              field_id: src_id
            target:
              field_id: tgt_source_id
          - source:
              constant: user
            target:
              field_id: tgt_entity_type
          - source:
              field_id: src_name
            target:
              field_id: tgt_name
          - source:
              field_id: src_email
            target:
              step_id: lowercase_email
          - source:
              step_id: lowercase_email
            target:
              field_id: tgt_email
      expect:
        status: 202
      save_as: mapping_response

  # Verify the mapping was created with correct data
  - assert:
      variable: mapping_response.id
      not_empty: true
      message: Mapping ID should be returned

  - assert:
      variable: mapping_response.description
      equals: "Simple mapping for testing"
      message: Mapping description should match

  # Read the mapping back and validate its structure
  - http_request:
      service: lotus
      method: GET
      path: /api/v1/mappings/definitions/{{mapping_response.id}}
      expect:
        status: 200
      save_as: mapping_get

  - assert:
      variable: mapping_get.description
      equals: "Simple mapping for testing"
      message: Retrieved mapping description should match

  # Create a binding for this mapping
  - http_request:
      service: lotus
      method: POST
      path: /api/v1/bindings
      body:
        name: "Test Binding {{uuid}}"
        mapping_id: "{{mapping_response.id}}"
        is_enabled: true
        output_topic: "test-mapped-data"
        filter:
          integration: "test-integration"
          keys:
            - "test-plan"
      expect:
        status: 201
      save_as: binding_response

  # Verify the binding was created with correct data
  - assert:
      variable: binding_response.id
      not_empty: true
      message: Binding ID should be returned

  - assert:
      variable: binding_response.mapping_id
      equals: "{{mapping_response.id}}"
      message: Binding should reference correct mapping

  - assert:
      variable: binding_response.is_enabled
      equals: true
      message: Binding should be enabled

  - assert:
      variable: binding_response.output_topic
      equals: "test-mapped-data"
      message: Binding output topic should match

  # Get binding to verify persistence
  - http_request:
      service: lotus
      method: GET
      path: /api/v1/bindings/{{binding_response.id}}
      expect:
        status: 200
      save_as: binding_get

  - assert:
      variable: binding_get.is_enabled
      equals: true
      message: Retrieved binding should be enabled

  # List bindings
  - http_request:
      service: lotus
      method: GET
      path: /api/v1/bindings
      expect:
        status: 200

  # Test executing the mapping with sample data
  - http_request:
      service: lotus
      method: POST
      path: /api/v1/mappings/execute
      body:
        id: "{{mapping_response.id}}"
        source_raw:
          data:
            id: "user-123"
            name: "John Doe"
            email: "JOHN.DOE@EXAMPLE.COM"
      expect:
        status: 200
      save_as: execute_response

  # Verify mapping execution produced correct output
  - assert:
      variable: execute_response.target_raw._source_id
      equals: "user-123"
      message: Source ID should be mapped

  - assert:
      variable: execute_response.target_raw._entity_type
      equals: "user"
      message: Entity type should be set to constant "user"

  - assert:
      variable: execute_response.target_raw.name
      equals: "John Doe"
      message: Name should be directly mapped

  - assert:
      variable: execute_response.target_raw.email
      equals: "john.doe@example.com"
      message: Email should be lowercased by transformer

cleanup:
  # Delete the binding first
  - http_request:
      service: lotus
      method: DELETE
      path: /api/v1/bindings/{{binding_response.id}}

  # Note: Mapping definitions may not have a delete endpoint,
  # or may require deactivation instead
