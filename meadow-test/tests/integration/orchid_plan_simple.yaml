name: Orchid Simple Plan Execution E2E
description: |
  The simplest possible Orchid E2E test:
  1. Create integration + config
  2. Create a single-step plan that fetches from mock API
  3. Trigger execution
  4. Verify execution completes
  5. Validate Kafka message contains expected data

steps:
  # ============================================================================
  # SETUP: Generate unique mock path
  # ============================================================================
  - set_variable:
      name: mock_path
      value: "/mock/simple-{{uuid}}"

  # Configure unique mock endpoint
  - http_request:
      service: mocks
      method: POST
      path: /api/test/configure
      body:
        method: GET
        path: "{{mock_path}}"
        response:
          status: 200
          body:
            status: "healthy"
            service: "simple-test"
      expect:
        status: 200

  # ============================================================================
  # SETUP: Integration + Config
  # ============================================================================
  
  - http_request:
      service: orchid
      method: POST
      path: /api/v1/integrations
      body:
        name: "Simple Test {{uuid}}"
        description: "Simple integration for basic execution test"
        config_schema:
          name: "Simple Config"
          schema:
            type: object
            properties:
              base_url:
                type: string
            required:
              - base_url
      expect:
        status: 201
      save_as: integration

  - assert:
      variable: integration.id
      not_empty: true
      message: Integration ID should be returned

  - http_request:
      service: orchid
      method: POST
      path: /api/v1/configs
      body:
        integration_id: "{{integration.id}}"
        name: "Simple Test Config"
        values:
          base_url: "{{mocks_url}}"
        enabled: true
      expect:
        status: 201
      save_as: config

  - assert:
      variable: config.id
      not_empty: true
      message: Config ID should be returned

  # ============================================================================
  # CREATE PLAN: Single GET request to mock health endpoint
  # ============================================================================

  - http_request:
      service: orchid
      method: POST
      path: /api/v1/plans
      body:
        integration_id: "{{integration.id}}"
        key: "simple-plan-{{uuid}}"
        name: "Simple Health Check Plan"
        description: "Fetches health endpoint from mock API"
        enabled: true
        plan_definition:
          step:
            url: "{{ config.base_url }}{{mock_path}}"
            method: GET
          max_execution_seconds: 30
      expect:
        status: 201
      save_as: plan

  - assert:
      variable: plan.key
      not_empty: true
      message: Plan key should be returned

  # Verify plan is retrievable
  - http_request:
      service: orchid
      method: GET
      path: /api/v1/plans/{{plan.key}}
      expect:
        status: 200
      save_as: plan_details

  - assert:
      variable: plan_details.integration_id
      equals: "{{integration.id}}"
      message: Plan should belong to correct integration

  # ============================================================================
  # RECORD KAFKA OFFSET (before triggering - for efficient message reading)
  # ============================================================================

  # ============================================================================
  # TRIGGER EXECUTION
  # ============================================================================

  - get_kafka_offset:
      topic: api-responses
      save_as: kafka_offset_before

  - http_request:
      service: orchid
      method: POST
      path: /api/v1/plans/{{plan.key}}/trigger
      body:
        config_id: "{{config.id}}"
      expect:
        status: 200
      save_as: trigger

  - assert:
      variable: trigger.status
      equals: "queued"
      message: Trigger should return queued status

  # Wait for execution to be picked up and completed
  - wait:
      duration: 3s
      reason: Allow execution queue to process

  # ============================================================================
  # QUERY FOR COMPLETED EXECUTION
  # ============================================================================

  - http_request:
      service: orchid
      method: GET
      path: /api/v1/executions?plan_key={{plan.key}}
      expect:
        status: 200
      save_as: executions

  # Get the first (most recent) execution
  - assert:
      variable: executions
      not_empty: true
      message: Should have at least one execution

  # ============================================================================
  # VALIDATE KAFKA MESSAGE
  # ============================================================================

  - assert_kafka_message:
      topic: api-responses
      timeout: 30s
      from_offset: "{{kafka_offset_before}}"
      filter:
        header: plan_key
        equals: "{{plan.key}}"
        # Only match API response messages (have request_url), not execution events
        has_field: request_url
        field_contains: request_url
        contains_value: "{{mock_path}}"
      assertions:
        # === Metadata validation ===
        - field: integration
          contains: "Simple Test"
        - field: plan_key
          equals: "{{plan.key}}"
        - field: config_id
          equals: "{{config.id}}"
        - field: execution_id
          not_empty: true

        # === Request validation ===
        - field: request_url
          contains: "/mock/simple-"
        - field: request_method
          equals: GET

        # === Response validation ===
        - field: status_code
          equals: 200

        # === ACTUAL DATA: Validate /health response structure ===
        # The mock API returns {"status": "healthy"} (wrapped in response_body array)
        - field: response_body[0].status
          equals: "healthy"

        # === Timing validation ===
        - field: duration_ms
          not_null: true
      save_as: kafka_message

cleanup:
  - http_request:
      service: mocks
      method: POST
      path: /api/test/configure/delete
      body:
        method: GET
        path: "{{mock_path}}"

  - http_request:
      service: orchid
      method: DELETE
      path: /api/v1/plans/{{plan.key}}

  - http_request:
      service: orchid
      method: DELETE
      path: /api/v1/configs/{{config.id}}

  - http_request:
      service: orchid
      method: DELETE
      path: /api/v1/integrations/{{integration.id}}
