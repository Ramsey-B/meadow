name: Orchid MS Graph Devices E2E
description: |
  End-to-end test for MS Graph devices sync:
  1. Create integration with MS Graph OAuth2
  2. Fetch devices from MS Graph API
  3. Validate Kafka message contains actual device data

  This tests a DIFFERENT MS Graph resource type (devices vs users)
  to ensure the pipeline handles various data structures.

steps:
  # ============================================================================
  # SETUP: Integration with MS Graph OAuth2
  # ============================================================================

  - http_request:
      service: orchid
      method: POST
      path: /api/v1/integrations
      body:
        name: "MS Graph Devices {{uuid}}"
        description: "Integration for MS Graph devices sync"
        config_schema:
          name: "MS Graph Devices Config"
          schema:
            type: object
            properties:
              base_url:
                type: string
              tenant_id:
                type: string
              client_id:
                type: string
              client_secret:
                type: string
            required:
              - base_url
              - tenant_id
              - client_id
              - client_secret
      expect:
        status: 201
      save_as: integration

  - http_request:
      service: orchid
      method: POST
      path: /api/v1/configs
      body:
        integration_id: "{{integration.id}}"
        name: "MS Graph Devices Config"
        values:
          base_url: "{{mocks_url}}"
          tenant_id: "test-tenant-id"
          client_id: "test-client-id"
          client_secret: "test-client-secret"
        enabled: true
      expect:
        status: 201
      save_as: config

  # ============================================================================
  # AUTH FLOW: MS Graph OAuth2
  # ============================================================================

  - http_request:
      service: orchid
      method: POST
      path: /api/v1/auth-flows
      body:
        integration_id: "{{integration.id}}"
        name: "MS Graph OAuth2 Devices"
        plan_definition:
          url: "{{ config.base_url }}/{{ config.tenant_id }}/oauth2/v2.0/token"
          method: POST
          headers:
            Content-Type: application/x-www-form-urlencoded
          body: "grant_type=client_credentials&client_id={{ config.client_id }}&client_secret={{ config.client_secret }}&scope=https://graph.microsoft.com/.default"
        token_path: "response.body.access_token"
        expires_in_path: "response.body.expires_in"
        header_name: "Authorization"
        header_format: "Bearer {token}"
        skew_seconds: 30
      expect:
        status: 201
      save_as: auth_flow

  # ============================================================================
  # PLAN: Fetch MS Graph devices
  # ============================================================================

  - http_request:
      service: orchid
      method: POST
      path: /api/v1/plans
      body:
        integration_id: "{{integration.id}}"
        key: "msgraph-devices-{{uuid}}"
        name: "MS Graph Devices Sync"
        description: "Fetch devices from MS Graph API"
        enabled: true
        plan_definition:
          step:
            auth_flow_id: "{{auth_flow.id}}"
            url: "{{ config.base_url }}/v1.0/devices"
            method: GET
            headers:
              Authorization: "{{ auth.headers.Authorization }}"
          max_execution_seconds: 60
      expect:
        status: 201
      save_as: plan

  - assert:
      variable: plan.key
      not_empty: true
      message: Plan should have a key

  # ============================================================================
  # RECORD KAFKA OFFSET (before triggering)
  # ============================================================================

  # ============================================================================
  # EXECUTE
  # ============================================================================

  - get_kafka_offset:
      topic: api-responses
      save_as: kafka_offset_before

  - http_request:
      service: orchid
      method: POST
      path: /api/v1/plans/{{plan.key}}/trigger
      body:
        config_id: "{{config.id}}"
      expect:
        status: 200
      save_as: trigger

  - assert:
      variable: trigger.status
      equals: "queued"
      message: Trigger should return queued status

  # ============================================================================
  # VERIFY EXECUTION
  # ============================================================================

  # Wait for execution to complete using polling template
  - use_template:
      name: wait_for_execution
      with:
        plan_key: "{{plan.key}}"

  - assert:
      variable: executions
      not_empty: true
      message: Should have at least one execution

  # ============================================================================
  # VALIDATE KAFKA: MS Graph devices have specific fields
  # ============================================================================

  - assert_kafka_message:
      topic: api-responses
      timeout: 60s
      from_offset: "{{kafka_offset_before}}"
      filter:
        headers:
          plan_key: "{{plan.key}}"
        has_field: request_url
      assertions:
        # === Metadata ===
        - field: plan_key
          equals: "{{plan.key}}"
        - field: config_id
          equals: "{{config.id}}"
        - field: execution_id
          not_empty: true

        # === Request ===
        - field: request_url
          contains: "/v1.0/devices"
        - field: request_method
          equals: GET
        - field: status_code
          equals: 200

        # === First device (John's MacBook) ===
        # MS Graph returns { "@odata.context": "...", "value": [...] } (wrapped in array)
        - field: response_body[0].value[0].id
          equals: "msg-device-001"
        - field: response_body[0].value[0].displayName
          equals: "John's MacBook"
        - field: response_body[0].value[0].deviceId
          equals: "dev-mac-001"
        - field: response_body[0].value[0].serialNumber
          equals: "C02XJ0HNJHD3"
        - field: response_body[0].value[0].operatingSystem
          equals: "MacOS"
        - field: response_body[0].value[0].operatingSystemVersion
          equals: "14.2"
        - field: response_body[0].value[0].trustType
          equals: "AzureAd"
        - field: response_body[0].value[0].isManaged
          equals: true
        - field: response_body[0].value[0].isCompliant
          equals: true

        # === Second device (John's iPhone) ===
        - field: response_body[0].value[1].id
          equals: "msg-device-002"
        - field: response_body[0].value[1].displayName
          equals: "John's iPhone"
        - field: response_body[0].value[1].operatingSystem
          equals: "iOS"
        - field: response_body[0].value[1].operatingSystemVersion
          equals: "17.2"

        # === Third device (Jane's Windows Laptop) ===
        - field: response_body[0].value[2].id
          equals: "msg-device-003"
        - field: response_body[0].value[2].displayName
          equals: "Jane's Windows Laptop"
        - field: response_body[0].value[2].operatingSystem
          equals: "Windows"

        # === Fourth device (Bob's Surface Pro - NOT compliant) ===
        - field: response_body[0].value[3].id
          equals: "msg-device-004"
        - field: response_body[0].value[3].displayName
          equals: "Bob's Surface Pro"
        - field: response_body[0].value[3].isCompliant
          equals: false
      save_as: kafka_msg

cleanup:
  - http_request:
      service: orchid
      method: DELETE
      path: /api/v1/plans/{{plan.key}}

  - http_request:
      service: orchid
      method: DELETE
      path: /api/v1/auth-flows/{{auth_flow.id}}

  - http_request:
      service: orchid
      method: DELETE
      path: /api/v1/configs/{{config.id}}

  - http_request:
      service: orchid
      method: DELETE
      path: /api/v1/integrations/{{integration.id}}
