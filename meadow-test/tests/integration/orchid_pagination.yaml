name: Orchid Pagination Tests
description: Test various pagination strategies for extracting data from APIs

steps:
  # Create integration for pagination tests
  - http_request:
      service: orchid
      method: POST
      path: /api/v1/integrations
      body:
        name: "Pagination Test Integration {{uuid}}"
        description: "Integration for testing pagination strategies"
        config_schema:
          name: "Pagination Config"
          schema:
            type: object
            properties:
              base_url:
                type: string
            required:
              - base_url
      expect:
        status: 201
      save_as: integration

  # Create config
  - http_request:
      service: orchid
      method: POST
      path: /api/v1/configs
      body:
        integration_id: "{{integration.id}}"
        name: "Pagination Config {{uuid}}"
        values:
          base_url: "http://localhost:8090"
        auth:
          type: none
      expect:
        status: 201
      save_as: config

  # Test 1: Cursor-based pagination (after/limit)
  - http_request:
      service: orchid
      method: POST
      path: /api/v1/plans
      body:
        integration_id: "{{integration.id}}"
        name: "Cursor Pagination Plan {{uuid}}"
        key: "cursor-pagination-{{uuid}}"
        description: "Test cursor-based pagination"
        steps:
          - id: fetch_with_cursor
            type: request
            method: GET
            path: /api/test/paginated/cursor
            pagination:
              type: cursor
              limit_param: limit
              cursor_param: after
              limit: 10
              response_path: pagination.next_cursor
              items_path: data
      expect:
        status: 201
      save_as: cursor_plan

  # Verify cursor plan created
  - assert:
      variable: cursor_plan.key
      not_empty: true
      message: Cursor pagination plan should be created

  # Test 2: Page-based pagination (page/per_page)
  - http_request:
      service: orchid
      method: POST
      path: /api/v1/plans
      body:
        integration_id: "{{integration.id}}"
        name: "Page Pagination Plan {{uuid}}"
        key: "page-pagination-{{uuid}}"
        description: "Test page-based pagination"
        steps:
          - id: fetch_with_pages
            type: request
            method: GET
            path: /api/test/paginated/pages
            pagination:
              type: page
              page_param: page
              per_page_param: per_page
              per_page: 10
              items_path: data
      expect:
        status: 201
      save_as: page_plan

  # Verify page plan created
  - assert:
      variable: page_plan.key
      not_empty: true
      message: Page pagination plan should be created

  # Test 3: Offset-based pagination (offset/limit)
  - http_request:
      service: orchid
      method: POST
      path: /api/v1/plans
      body:
        integration_id: "{{integration.id}}"
        name: "Offset Pagination Plan {{uuid}}"
        key: "offset-pagination-{{uuid}}"
        description: "Test offset-based pagination"
        steps:
          - id: fetch_with_offset
            type: request
            method: GET
            path: /api/test/paginated/offset
            pagination:
              type: offset
              offset_param: offset
              limit_param: limit
              limit: 10
              items_path: data
      expect:
        status: 201
      save_as: offset_plan

  # Verify offset plan created
  - assert:
      variable: offset_plan.key
      not_empty: true
      message: Offset pagination plan should be created

  # Test 4: Link header pagination
  - http_request:
      service: orchid
      method: POST
      path: /api/v1/plans
      body:
        integration_id: "{{integration.id}}"
        name: "Link Header Pagination Plan {{uuid}}"
        key: "link-pagination-{{uuid}}"
        description: "Test link header pagination"
        steps:
          - id: fetch_with_links
            type: request
            method: GET
            path: /api/test/paginated/links
            pagination:
              type: link_header
              rel: next
              items_path: data
      expect:
        status: 201
      save_as: link_plan

  # Verify link plan created
  - assert:
      variable: link_plan.key
      not_empty: true
      message: Link header pagination plan should be created

cleanup:
  # Clean up plans
  - http_request:
      service: orchid
      method: DELETE
      path: /api/v1/plans/{{cursor_plan.key}}

  - http_request:
      service: orchid
      method: DELETE
      path: /api/v1/plans/{{page_plan.key}}

  - http_request:
      service: orchid
      method: DELETE
      path: /api/v1/plans/{{offset_plan.key}}

  - http_request:
      service: orchid
      method: DELETE
      path: /api/v1/plans/{{link_plan.key}}

  # Clean up config and integration
  - http_request:
      service: orchid
      method: DELETE
      path: /api/v1/configs/{{config.id}}

  - http_request:
      service: orchid
      method: DELETE
      path: /api/v1/integrations/{{integration.id}}
