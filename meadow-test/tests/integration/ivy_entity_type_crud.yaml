name: Ivy Entity Type CRUD Operations
description: |
  Tests full CRUD operations for entity types in Ivy:
  - Create entity type with schema
  - Read/list entity types
  - Update entity type properties
  - Delete entity type

steps:
  # ============================================================================
  # TEST 1: Create entity type with schema
  # ============================================================================
  - http_request:
      service: ivy
      method: POST
      path: /api/v1/entity-types
      body:
        key: "employee{{timestamp}}"
        name: "Employee"
        description: "Employee entity for CRUD testing"
        schema:
          type: object
          properties:
            employee_id:
              type: string
            first_name:
              type: string
            last_name:
              type: string
            email:
              type: string
              format: email
            department:
              type: string
            is_active:
              type: boolean
          required:
            - employee_id
            - email
      expect:
        status: 201
      save_as: entity_type

  # Verify entity type was created with correct properties
  - assert:
      variable: entity_type.id
      not_empty: true
      message: Entity type ID should be returned

  - assert:
      variable: entity_type.key
      contains: "employee"
      message: Entity type key should contain 'employee'

  - assert:
      variable: entity_type.name
      equals: "Employee"
      message: Entity type name should be 'Employee'

  - assert:
      variable: entity_type.description
      equals: "Employee entity for CRUD testing"
      message: Description should match

  # ============================================================================
  # TEST 2: List entity types and verify ours exists
  # ============================================================================
  - http_request:
      service: ivy
      method: GET
      path: /api/v1/entity-types
      expect:
        status: 200
      save_as: list_response

  - assert:
      variable: list_response.items
      not_empty: true
      message: Entity types list should not be empty

  # ============================================================================
  # TEST 3: Get entity type by ID
  # ============================================================================
  - http_request:
      service: ivy
      method: GET
      path: /api/v1/entity-types/{{entity_type.id}}
      expect:
        status: 200
      save_as: get_response

  - assert:
      variable: get_response.id
      equals: "{{entity_type.id}}"
      message: Retrieved entity type ID should match

  - assert:
      variable: get_response.name
      equals: "Employee"
      message: Retrieved name should match

  # ============================================================================
  # TEST 4: Create another entity type for deletion test
  # ============================================================================
  - http_request:
      service: ivy
      method: POST
      path: /api/v1/entity-types
      body:
        key: "temp{{timestamp}}"
        name: "Temporary"
        description: "Entity type to be deleted"
        schema:
          type: object
          properties:
            id:
              type: string
          required:
            - id
      expect:
        status: 201
      save_as: temp_entity_type

  # ============================================================================
  # TEST 7: Delete entity type
  # ============================================================================
  - http_request:
      service: ivy
      method: DELETE
      path: /api/v1/entity-types/{{temp_entity_type.id}}
      expect:
        status: 204

  # Verify deletion - should return 404
  - http_request:
      service: ivy
      method: GET
      path: /api/v1/entity-types/{{temp_entity_type.id}}
      expect:
        status: 404


cleanup:
  # Clean up the entity type we created
  - http_request:
      service: ivy
      method: DELETE
      path: /api/v1/entity-types/{{entity_type.id}}
